# ----------------------------------------------
# âš™ï¸ Kubernetes Deployment for Node.js Backend
# ----------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sustainat-backend            # ğŸ“› Name of the deployment
  namespace: sustainat               # ğŸ“¦ In the "sustainat" namespace
  labels:
    app: sustainat-backend           # ğŸ·ï¸ Label to group this app

spec:
  replicas: 1                        # ğŸ‘¶ One pod to start with
  selector:
    matchLabels:
      app: sustainat-backend         # ğŸ¯ Must match pod label

  template:
    metadata:
      labels:
        app: sustainat-backend       # âœ… Pod label
    spec:
      containers:
        - name: sustainat-backend
          image: sustainatltd/backend:latest       # ğŸ³ This is your updated Docker image!
          imagePullPolicy: Always

          ports:
            - containerPort: 5001                  # ğŸšª Exposes backend on port 5001

          env:                                     
            # ğŸ” Load MongoDB URI securely from Kubernetes Secret
            - name: MONGO_URI
              valueFrom:
                secretKeyRef:
                  name: mongo-secret               # ğŸ”‘ Secret name
                  key: MONGO_URI                   # ğŸ”‘ Key inside the secret

            # ğŸ” Hardcoded for now, or move to secret later
            - name: JWT_SECRET
              value: thisisasecretkey              # Used by backend for JWT token signing
---
# ğŸŒ Exposes the backend to outside world using NodePort
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: sustainat
spec:
  selector:
    app: sustainat-backend                         # ğŸ§² Targets pods with this label
  ports:
    - protocol: TCP
      port: 80                                     # ğŸŒ External port
      targetPort: 5001                             # ğŸšª Port inside the container
      nodePort: 30011                              # ğŸŒ Access this using Minikube IP + 30011
  type: NodePort

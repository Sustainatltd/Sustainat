# -----------------------------------------------------
# ğŸ“„ 1. ConfigMap â€” Automatically connects Grafana to Prometheus
# -----------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasource               # ğŸ“› Name of the config
  namespace: monitoring                  # ğŸ“¦ Belongs to "monitoring" namespace
data:
  datasource.yaml: |                     # ğŸ“„ This will be mounted as a config file in Grafana
    apiVersion: 1
    datasources:
      - name: Prometheus                 # ğŸ“Š Name of the datasource inside Grafana UI
        type: prometheus                 # ğŸ”Œ Datasource type is Prometheus
        access: proxy                    # ğŸ“¡ Grafana will fetch metrics through proxy internally
        url: http://prometheus-service.monitoring.svc.cluster.local:9090
        # ğŸŒ This is the internal Kubernetes DNS name of your Prometheus service
        isDefault: true                  # âœ… Make this the default data source in Grafana

---
# -----------------------------------------------------
# ğŸš€ 2. Deployment â€” Runs Grafana container inside Kubernetes
# -----------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana-deployment              # ğŸ“› Name of this deployment
  namespace: monitoring                 # ğŸ“¦ Same namespace as Prometheus
spec:
  replicas: 1                           # ğŸ‘¤ Run just one Grafana pod for now
  selector:
    matchLabels:
      app: grafana                      # ğŸ” Selects the pod using this label

  template:
    metadata:
      labels:
        app: grafana                    # ğŸ·ï¸ Pod will have this label
    spec:
      containers:
        - name: grafana                         # ğŸ³ Name of the container
          image: grafana/grafana:latest         # ğŸ“¥ Pull Grafana image from Docker Hub
          ports:
            - containerPort: 3000               # ğŸšª Port inside the container for Grafana UI

          volumeMounts:
            - name: grafana-storage
              mountPath: /var/lib/grafana       # ğŸ’¾ Path to store dashboards and data
            - name: grafana-config
              mountPath: /etc/grafana/provisioning/datasources
              # ğŸ“ This is where Grafana looks for datasource YAMLs

      volumes:
        - name: grafana-storage
          emptyDir: {}                   # ğŸ—‚ï¸ Temporary in-memory storage (gone if pod restarts)
        - name: grafana-config
          configMap:
            name: grafana-datasource     # ğŸ”— Use the ConfigMap from above

---
# -----------------------------------------------------
# ğŸŒ 3. Service â€” Exposes Grafana to your browser (NodePort)
# -----------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: grafana-service                  # ğŸ“› Name of the service
  namespace: monitoring                  # ğŸ“¦ Must match the namespace of the deployment
spec:
  type: NodePort                         # ğŸŒ Expose Grafana on your host (Minikube style)
  selector:
    app: grafana                         # ğŸ¯ Match the pod label
  ports:
    - port: 3000                         # ğŸ“¡ Internal port inside Kubernetes cluster
      targetPort: 3000                   # ğŸ¯ Same port Grafana listens on
      nodePort: 30009                    # ğŸŒ Access from browser: http://localhost:30009

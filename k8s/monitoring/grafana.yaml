# -----------------------------------------------------
# ğŸ“¦ ConfigMap to automatically connect Grafana to Prometheus
# -----------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasource               # ğŸ·ï¸ Name of the config map
  namespace: monitoring                  # ğŸ“¦ Placed inside the "monitoring" namespace
data:
  datasource.yaml: |                     # ğŸ“„ This is the actual file inside the config map
    apiVersion: 1
    datasources:
      - name: Prometheus                 # ğŸ“Š This is the data source name shown in Grafana
        type: prometheus                 # ğŸ”Œ We're connecting to Prometheus
        access: proxy                    # ğŸ“¡ Proxy = Grafana will handle the request for you
        url: http://prometheus-service.monitoring.svc.cluster.local:9090  # ğŸŒ Prometheus service URL inside Kubernetes
        isDefault: true                  # âœ… Set this as the default data source

---
# -----------------------------------------------------
# ğŸš€ Grafana Deployment (runs the Grafana container)
# -----------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana-deployment              # ğŸ·ï¸ Name of the deployment
  namespace: monitoring                 # ğŸ“¦ Inside the "monitoring" namespace
spec:
  replicas: 1                           # ğŸ‘¥ We only want 1 pod running
  selector:
    matchLabels:
      app: grafana                      # ğŸ” Match pods with this label
  template:
    metadata:
      labels:
        app: grafana                    # ğŸ·ï¸ Label the pod as "grafana"
    spec:
      containers:
        - name: grafana                 # ğŸ“¦ Container name
          image: grafana/grafana:latest # ğŸ–¼ï¸ Docker image from Docker Hub
          ports:
            - containerPort: 3000      # ğŸšª Grafana listens inside the container on port 3000
          volumeMounts:
            - name: grafana-storage
              mountPath: /var/lib/grafana   # ğŸ’¾ Where Grafana saves dashboards/data
            - name: grafana-config
              mountPath: /etc/grafana/provisioning/datasources  # ğŸ“ Where the datasource config is mounted
      volumes:
        - name: grafana-storage
          emptyDir: {}                 # ğŸ—‚ï¸ Temporary in-memory storage for Grafana (non-persistent)
        - name: grafana-config
          configMap:
            name: grafana-datasource   # ğŸ”— Connects to the ConfigMap we defined above

---
# -----------------------------------------------------
# ğŸŒ Grafana Service (to access Grafana in browser)
# -----------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: grafana-service                 # ğŸ·ï¸ Name of the service
  namespace: monitoring                # ğŸ“¦ In the "monitoring" namespace
spec:
  type: NodePort                       # ğŸŒ Expose it outside using a port on your machine
  selector:
    app: grafana                      # ğŸ” Link this service to the Grafana pod
  ports:
    - port: 3000                      # ğŸ“¥ Internal service port (used inside the cluster)
      targetPort: 3000               # ğŸ¯ Port that the pod/container listens to
      nodePort: 30009                # ğŸŒ Port exposed to your laptop/browser (http://localhost:30009)

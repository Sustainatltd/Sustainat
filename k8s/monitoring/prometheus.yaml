# ---------------------------------------------
# ğŸ“„ 1. ConfigMap â€” This tells Prometheus where to scrape metrics from
# ---------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config                 # ğŸ·ï¸ Name of the config (referenced in Deployment)
  namespace: monitoring                   # ğŸ“¦ Put this in the "monitoring" namespace
  labels:
    name: prometheus-config               # ğŸ“› Just a label for organizing
data:
  prometheus.yml: |                       # ğŸ“„ This is the actual Prometheus config file (inside the pod)
    global:
      scrape_interval: 15s                # â±ï¸ Prometheus will collect metrics every 15 seconds

    scrape_configs:
      - job_name: 'kubernetes-services'   # ğŸ·ï¸ Friendly name shown in Prometheus UI
        static_configs:
          - targets:                      # ğŸ¯ List of services to scrape (get metrics from)
              - sustainat-backend-service.sustainat.svc.cluster.local:5001
              # ğŸ‘† This is the backend's internal DNS name inside Kubernetes
              # It must match your backend service name + namespace + port
# ---------------------------------------------
# ğŸš€ 2. Deployment â€” This runs the Prometheus app
# ---------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus-deployment             # ğŸ·ï¸ Name of the deployment
  namespace: monitoring                   # ğŸ“¦ Put in "monitoring" namespace
spec:
  replicas: 1                             # ğŸ‘¤ Only one copy needed
  selector:
    matchLabels:
      app: prometheus                     # ğŸ” Used to connect the pod with the service
  template:
    metadata:
      labels:
        app: prometheus                   # ğŸ·ï¸ Label for this pod
    spec:
      containers:
        - name: prometheus                # ğŸ“¦ Container name
          image: prom/prometheus:latest   # ğŸ–¼ï¸ Use official Prometheus image
          args:
            - "--config.file=/etc/prometheus/prometheus.yml"
            # ğŸ”§ This tells Prometheus where to find the config file
          ports:
            - containerPort: 9090         # ğŸšª Prometheus listens inside the pod on this port
          volumeMounts:
            - name: config-volume
              mountPath: /etc/prometheus  # ğŸ“ Mount the configMap inside the container
      volumes:
        - name: config-volume
          configMap:
            name: prometheus-config       # ğŸ”— Connect the volume to our ConfigMap above
# ---------------------------------------------
# ğŸŒ 3. Service â€” Makes Prometheus accessible in browser
# ---------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: prometheus-service                # ğŸ·ï¸ Name of the service
  namespace: monitoring                   # ğŸ“¦ Must match the namespace of the deployment
spec:
  type: NodePort                          # ğŸŒ Exposes the app on a localhost port (via Minikube)
  selector:
    app: prometheus                       # ğŸ”— This service links to the pod via label
  ports:
    - port: 9090                          # ğŸ“¥ Internal cluster port
      targetPort: 9090                   # ğŸ¯ Prometheus is listening on this port inside pod
      nodePort: 30090                    # ğŸŒ External port (use http://localhost:30090 to open)

# ----------------------------------------------------
# ğŸ“„ 1. ConfigMap â€” Tells Prometheus what to monitor
# ----------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config                  # ğŸ“› Unique name of the config
  namespace: monitoring                    # ğŸ“¦ Put this config inside "monitoring" namespace
  labels:
    name: prometheus-config                # ğŸ·ï¸ Optional label for organization

data:
  prometheus.yml: |                        # ğŸ“„ Start of the Prometheus configuration file
    global:
      scrape_interval: 15s                 # â±ï¸ Prometheus checks every 15 seconds

    scrape_configs:
      - job_name: 'kubernetes-services'    # ğŸ·ï¸ Name shown on Prometheus UI
        static_configs:
          - targets:                       # ğŸ¯ List of services Prometheus will scrape
              - sustainat-backend-service.sustainat.svc.cluster.local:5001
              # ğŸ§  This is the internal Kubernetes DNS to reach the backend service
              # Format: <service-name>.<namespace>.svc.cluster.local:<port>

---
# ----------------------------------------------------
# ğŸš€ 2. Deployment â€” Launches Prometheus app
# ----------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus-deployment             # ğŸ“› Deployment name
  namespace: monitoring                   # ğŸ“¦ Same namespace as the config
spec:
  replicas: 1                             # ğŸ‘¤ One Prometheus pod is enough for now
  selector:
    matchLabels:
      app: prometheus                     # ğŸ” Used to connect to the service below

  template:
    metadata:
      labels:
        app: prometheus                   # ğŸ·ï¸ Label assigned to this pod
    spec:
      containers:
        - name: prometheus                # ğŸ³ Container name
          image: prom/prometheus:latest   # ğŸ“¥ Official Prometheus image from Docker Hub
          args:
            - "--config.file=/etc/prometheus/prometheus.yml"  # âš™ï¸ Load config from mounted path
          ports:
            - containerPort: 9090         # ğŸšª Prometheus dashboard runs on this port
          volumeMounts:
            - name: config-volume
              mountPath: /etc/prometheus  # ğŸ“ Mount configMap to this path inside the container

      volumes:
        - name: config-volume
          configMap:
            name: prometheus-config       # ğŸ”— Use the ConfigMap defined above

---
# ----------------------------------------------------
# ğŸŒ 3. Service â€” Exposes Prometheus to browser
# ----------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: prometheus-service                # ğŸ“› Name of the service
  namespace: monitoring                   # ğŸ“¦ Same namespace as deployment
spec:
  type: NodePort                          # ğŸŒ Exposes service outside (great for Minikube)
  selector:
    app: prometheus                       # ğŸ¯ Selects pods with this label
  ports:
    - port: 9090                          # ğŸ“¡ Port used inside cluster
      targetPort: 9090                    # ğŸ¯ Port used inside Prometheus container
      nodePort: 30090                     # ğŸ–¥ï¸ Access Prometheus via http://localhost:30090
